<div class="modal-container">
  <div class="modal-header">
    <h2 mat-dialog-title>Customer {{ customerName }} - New Order</h2>
  </div>

  <div mat-dialog-content class="modal-content">
    @if (loading) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading form data...</p>
      </div>
    } @else {
      <form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="order-form">
        
        <!-- Order Section -->
        <div class="form-section">
          <h3 class="section-title">Order</h3>
          
          <!-- Employee and Shipper Row -->
          <div class="form-row">
            <mat-form-field appearance="fill">
              <mat-label>Employee</mat-label>
              <mat-select formControlName="empId" required>
                @for (employee of employees; track employee.id) {
                  <mat-option [value]="employee.id">{{ employee.fullName }}</mat-option>
                }
              </mat-select>
              <mat-error>{{ getFieldError('empId') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Shipper</mat-label>
              <mat-select formControlName="shipperId" required>
                @for (shipper of shippers; track shipper.id) {
                  <mat-option [value]="shipper.id">{{ shipper.companyName }}</mat-option>
                }
              </mat-select>
              <mat-error>{{ getFieldError('shipperId') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Ship Name Full Width Row -->
          <div class="form-row-full">
            <mat-form-field appearance="fill">
              <mat-label>Ship Name</mat-label>
              <input matInput formControlName="shipName" required>
              <mat-error>{{ getFieldError('shipName') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Ship Address, City, Country Row -->
          <div class="form-row-three">
            <mat-form-field appearance="fill">
              <mat-label>Ship Address</mat-label>
              <input matInput formControlName="shipAddress" required>
              <mat-error>{{ getFieldError('shipAddress') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Ship City</mat-label>
              <input matInput formControlName="shipCity" required>
              <mat-error>{{ getFieldError('shipCity') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Ship Country</mat-label>
              <input matInput formControlName="shipCountry" required>
              <mat-error>{{ getFieldError('shipCountry') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Order Date, Required Date, Shipped Date Row -->
          <div class="form-row-three">
            <mat-form-field appearance="fill">
              <mat-label>Order Date</mat-label>
              <input matInput [matDatepicker]="orderDatePicker" formControlName="orderDate" required>
              <mat-datepicker-toggle matIconSuffix [for]="orderDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #orderDatePicker></mat-datepicker>
              <mat-error>{{ getFieldError('orderDate') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Required Date</mat-label>
              <input matInput [matDatepicker]="requiredDatePicker" formControlName="requiredDate" required>
              <mat-datepicker-toggle matIconSuffix [for]="requiredDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #requiredDatePicker></mat-datepicker>
              <mat-error>{{ getFieldError('requiredDate') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Shipped Date</mat-label>
              <input matInput [matDatepicker]="shippedDatePicker" formControlName="shippedDate">
              <mat-datepicker-toggle matIconSuffix [for]="shippedDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #shippedDatePicker></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Freight Full Width Row -->
          <div class="form-row-full">
            <mat-form-field appearance="fill">
              <mat-label>Freight</mat-label>
              <input matInput type="number" formControlName="freight" step="0.01" min="0" required>
              <span matTextPrefix>$</span>
              <mat-error>{{ getFieldError('freight') }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Order Details Section -->
        <div class="form-section">
          <h3 class="section-title">Order Details</h3>
          
          <!-- Product Full Width Row -->
          <div class="form-row-full">
            <mat-form-field appearance="fill">
              <mat-label>Product</mat-label>
              <mat-select formControlName="productId" (selectionChange)="onProductChange($event.value)" required>
                @for (product of products; track product.id) {
                  <mat-option [value]="product.id">{{ product.productName }}</mat-option>
                }
              </mat-select>
              <mat-error>{{ getFieldError('productId') }}</mat-error>
            </mat-form-field>
          </div>

          <!-- Unit Price, Quantity, Discount Row -->
          <div class="form-row-three">
            <mat-form-field appearance="fill">
              <mat-label>Unit Price</mat-label>
              <input matInput type="number" formControlName="unitPrice" step="0.01" min="0" required>
              <span matTextPrefix>$</span>
              <mat-error>{{ getFieldError('unitPrice') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Quantity</mat-label>
              <input matInput type="number" formControlName="qty" min="1" required>
              <mat-error>{{ getFieldError('qty') }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Discount</mat-label>
              <input matInput type="number" formControlName="discount" step="0.01" min="0" max="1">
              <span matTextSuffix>%</span>
              <mat-error>{{ getFieldError('discount') }}</mat-error>
            </mat-form-field>
          </div>

        </div>

        @if (error) {
          <div class="error-message">
            <mat-icon>error</mat-icon>
            {{ error }}
          </div>
        }
      </form>
    }
  </div>

  <div mat-dialog-actions class="modal-actions">
    <button mat-button class="close-button" (click)="onCancel()" [disabled]="submitting">CLOSE</button>
    <button 
      mat-button 
      class="save-button"
      (click)="onSubmit()" 
      [disabled]="submitting || orderForm.invalid"
      type="submit">
      @if (submitting) {
        <mat-spinner diameter="20"></mat-spinner>
        Saving...
      } @else {
        SAVE
      }
    </button>
  </div>
</div>